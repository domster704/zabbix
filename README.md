# Zabbix

Zabbix — это система мониторинга, которая позволяет отслеживать состояние серверов, приложений, сетевого оборудования и
других IT-ресурсов. В данной конфигурации используется связка Zabbix Server + Web-интерфейс + Agent2 + PostgreSQL,
развёрнутая с помощью Docker.

---

## Зачем нужен?

- **Сбор метрик**: нагрузка на CPU, RAM, диски, сетевые интерфейсы и прочее.
- **Отслеживание событий**: падения служб, недоступность ресурсов, сбои в приложениях.
- **Алерты и уведомления**: email, Telegram, Slack и др.
- **Гибкая настройка и масштабируемость**: удобное добавление хостов, шаблонов, SNMP-устройств и т.д.
- **Визуализация**: графики, карты сети, панели мониторинга.

## О файлах

### `docker-compose_agent.yml`

Используется для развёртывания только агента Zabbix (zabbix-agent2), который передаёт данные на сервер Zabbix.

> ⚠️ Обязательно задать ZBX_HOSTNAME, иначе агент не сможет корректно зарегистрироваться на сервере.

### `docker-compose_host.yml`

Комплексный `docker-compose`-файл для развертывания всей инфраструктуры Zabbix:

- PostgreSQL — база данных Zabbix.
- Zabbix Server — основная служба, собирающая и обрабатывающая данные.
- Zabbix Web — веб-интерфейс (доступ по порту 20080).
- SNMP traps — ловушка SNMP для обработки SNMP-сообщений от сетевых устройств.
- Zabbix Agent2 — агент, установленный на том же хосте, что и сервер, передаёт локальные метрики.

### `zabbix-agent.psk`

Файл с pre-shared key, который необходим для шифрования передаваемых метрик.

Следующая команда обязательна для выполнения. Создаётся следующим путём:

```Bash
openssl rand -hex 32 > ./psk/zabbix-agent.psk
```

### `.env`

Тут нас интересует переменная `ZABBIX_AGENT_PSK_ID`.

Следующая команда обязательна для выполнения. Создаётся следующим путём:

```Bash
echo "ZABBIX_AGENT_PSK_ID=$(cat /etc/machine-id)" >> .env
```

#### Бэкапы

Для бэкапов используйте следующую команду:

```Bash
docker exec postgres-server pg_dump -U zabbix zabbix > zabbix_$(date +%F).sql
```

#### Особенности:

- Используется сеть zabbix-net с явно заданным диапазоном IP.
- Все компоненты подключены к общей сети для упрощения взаимодействия.
- Переменные окружения централизованы и управляются через .env.
- На хосте **НЕ** надо отдельно запускать Агента2, так как в `docker-compose_host.yml` уже настроена конфигурация для
  локального Агента2

### `docker-compose_zabbix-proxy-for-balena.yml`

Используется для развёртывания **Zabbix Proxy** в окружении _open-balena_.  
Контейнер подключается к уже запущенному VPN-контейнеру `open-balena-vpn` с помощью
`network_mode: "container:open-balena-vpn-1"`, поэтому внешний
порт-форвардинг не требуется — весь трафик к центральному серверу идёт через
защищённый VPN-туннель.

**Кратко, зачем нужен прокси**

- Собирает метрики с устройств в удалённом сегменте и кеширует их локально,
  если связь с главным сервером потеряна. Данные будут отправлены при
  восстановлении соединения.
- Снижает нагрузку на центральный Zabbix Server, агрегируя запросы.
- Позволяет мониторить сотни устройств, находящихся за NAT/Firewall/VPN, без
  открытия дополнительных портов.

**Ключевые переменные окружения**

| Переменная        | Значение по умолчанию | Описание                                                        |
|-------------------|-----------------------|-----------------------------------------------------------------|
| `ZBX_HOSTNAME`    | `zabbix-proxy-vpn`    | Имя прокси, должно совпадать с настройками сервера.             |
| `ZBX_SERVER_HOST` | `${ZABBIX_SERVER_IP}` | IP сервера Zabbix.                                              |
| `ZBX_SERVER_PORT` | `10051`               | Порт сервера Zabbix.                                            |
| `ZBX_PROXYMODE`   | `0`                   | 0 — активный (прокси сам инициирует соединение); 1 — пассивный. |
| `ZBX_DEBUGLEVEL`  | `3`                   | Уровень логирования (0–5).                                      |

> ⚠️ Убедись, что прокси добавлен на сервере **до** запуска контейнера, иначе он не пройдёт авторизацию.

**Хранилище данных**

Прокси использует встроенную базу SQLite, которая монтируется в каталог
`./zbx-sqlite-data`. Объём диска зависит от количества и частоты собираемых
метрик; для небольших площадок обычно достаточно 200–500 МБ.

Папку `./zbx-sqlite-data` нужно предварительно создать вручную в папке, откуда вызывается
`docker compose up --build -d`.
Также для папки нужно ввести следующие команды:

```bash
mkdir -p ./zbx-sqlite-data
sudo chown 1000:1000 ./zbx-sqlite-data
chmod 755 ./zbx-sqlite-data
```

А для базы данных, которую также нужно предварительно создать, следующие команды:

```Bash
touch ./zbx-sqlite-data/zabbix-proxy-vpn.sqlite
chmod 666 ./zbx-sqlite-data/zabbix-proxy-vpn.sqlite
chmod 777 ./zbx-sqlite-data/
```

После успешной регистрации прокси станет доступен в веб-интерфейсе  
**Administration → Proxies**.

## Запуск

1. Создай папку /var/www/zabbix
2. Склонируй репозиторий
3. Убедись, что Docker и Docker Compose установлены.
4. Измени файл `.env` или создай его, если он ещё не существует:

   ```env
   ZABBIX_SERVER_IP=172.20.240.10 (или zabbix.example.com)
   ```

5. Запусти инфраструктуру:

   ```bash
   docker compose -f docker-compose_host.yml up -d --build
   ```

6. Для запуска только агента (на другом хосте):

   ```bash
   docker compose -f docker-compose_agent.yml up -d --build
   ```

7. Перейди в веб-интерфейс: `https://<domain or ip>`  
   Логин: `Admin`, пароль: `zabbix` (по умолчанию)
8. Для запуска прокси-сервера Zabbix для OpenBalena:

    ```Bash
    docker compose -f docker-compose_zabbix-proxy-for-balena.yml up -d --build
    ```

## Потребляемые ресурсы

### Агент2

```text
CONTAINER ID   NAME                     CPU %     MEM USAGE / LIMIT     MEM %     NET I/O           BLOCK I/O         PIDS
c35316d27ad6   zabbix-agent2            0.67%     10.41MiB / 11.75GiB   0.09%     21.4kB / 25.8kB   5.52MB / 4.1kB    14
```

### Хост

```text
CONTAINER ID   NAME                     CPU %     MEM USAGE / LIMIT     MEM %     NET I/O           BLOCK I/O        PIDS 
75a352e70637   zabbix-agent2            0.14%     12.63MiB / 9.783GiB   0.13%     2.65MB / 3.25MB   4.1kB / 28.7kB   12 
8c63041eaa77   zabbix-web-nginx-pgsql   0.02%     128.3MiB / 9.783GiB   1.28%     176MB / 97.9MB    102kB / 24.6kB   17 
1a95861baa07   zabbix-server-pgsql      0.59%     51.66MiB / 9.783GiB   0.52%     664MB / 38.8MB    1.17MB / 193kB   78 
b87d1c33d39b   zabbix-snmptraps         0.00%     3.102MiB / 9.783GiB   0.03%     3.22kB / 126B     0B / 4.1kB       1 
d3ab7766fcf6   postgres-server          0.87%     149.1MiB / 9.783GiB   1.49%     59.3MB / 825MB    733kB / 64MB     38
```

### Прокси

```text
CONTAINER ID   NAME                     CPU %     MEM USAGE / LIMIT     MEM %     NET I/O           BLOCK I/O         PIDS
44d99fc813c1   zabbix-proxy             0.52%     37.39MiB / 11.75GiB   0.31%     2.82GB / 2.88GB   0B / 0B           56
```
